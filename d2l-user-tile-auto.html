<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../d2l-organization-hm-behavior/d2l-organization-hm-behavior.html">
<link rel="import" href="../d2l-hm-constants-behavior/d2l-hm-constants-behavior.html">
<link rel="import" href="d2l-user-tile.html">

<dom-module id="d2l-user-tile-auto">
	<template>
		<style>
			:host {
				display: inline-block;
				height: auto;
			}

			d2l-user-tile {
				width: 100%;
				min-height: 100%;
				height: inherit;
				margin: 0;
			}
		</style>

		<iron-ajax id="enrollmentsRequest" url="[[_enrollmentsUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onEnrollmentsResponse"></iron-ajax>
		<iron-ajax id="institutionRequest" url="[[_institutionUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onInstitutionResponse"></iron-ajax>
		<iron-ajax id="organizationImageRequest" url="[[_organizationImageUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onOrganizationImageResponse"></iron-ajax>
		<iron-ajax id="organizationsRequest" url="[[_organizationsUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onOrganizationsResponse"></iron-ajax>
		<iron-ajax id="rootRequest" url="[[_rootUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onRootResponse"></iron-ajax>
		<iron-ajax id="userRequest" url="[[userUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onUserResponse"></iron-ajax>
		<iron-ajax id="themeRequest" url="[[_themeUrl]]" headers="[[_headers]]" on-iron-ajax-response="_onThemeResponse"></iron-ajax>

		<d2l-user-tile
			name=[[_name]]
			school=[[_school]]
			icon=[[_iconUrl]]
			background=[[_backgroundUrl]]
			background-color=[[_backgroundColor]]
			token=[[token]]
		>
			<slot></slot>
		</d2l-user-tile>
	</template>
	<script src="https://s.brightspace.com/lib/siren-parser/6.0.0/siren-parser.js"></script>
	<script>
	'use strict';
	Polymer({
		is: 'd2l-user-tile-auto',
		properties: {
			token: String,
			userUrl: String,
			_authorization: String,
			_backgroundColor: String,
			_backgroundUrl: String,
			_enrollmentsUrl: String,
			_headers: String,
			_iconUrl: String,
			_institutionUrl: String,
			_name: String,
			_organizationImageUrl: String,
			_organizationsUrl: String,
			_previousUserCall: Object,
			_school: String,
			_themeUrl: String
		},
		observers: [
			'_onUserChange( userUrl, token )'
		],
		behaviors: [
			window.D2L.Hypermedia.OrganizationHMBehavior,
			window.D2L.Hypermedia.HMConstantsBehavior
		],
		ready: function() {
			this._generateUserRequest();
		},
		_onUserChange: function() {
			this._generateUserRequest();
		},
		_generateRequest: function(url, method, headers) {
			return new Request(url, {method: method, headers: headers});
		},
		_generateUserRequest: function() {
			this._previousUserCall = this._previousUserCall || {};
			if (
				this.userUrl &&
				this.token &&
				this.userUrl !== this._previousUserCall.userUrl &&
				this.token !== this._previousUserCall.token
			) {
				this._previousUserCall = { userUrl: this.userUrl, token: this.token };
				this._authorization = 'Bearer ' + this.token;
				this._headers = {
					Authorization: this._authorization,
					Accept: 'application/vnd.siren+json'
				};
				window.d2lauthify.fetchAsJson(this._generateRequest(this.userUrl, "GET", this._headers)).then(this._onUserResponse.bind(this));
			}
		},
		_onUserResponse: function(response) {
			if (response.status === 200) {
				var userResponse = window.D2L.Hypermedia.Siren.Parse(response.detail);
				this._name = (userResponse.getSubEntityByRel(this.HypermediaRels.displayName) || { properties: {} }).properties.name;
				var profile = userResponse.getSubEntityByRel(this.HypermediaRels.userProfile);
				if (profile) {
					var image = profile.getSubEntityByRel(this.HypermediaRels.profileImage);
					if (image.class.indexOf('default-image') > -1) {
						this._iconUrl = null;
					} else {
						this._iconUrl = (image.getLinkByRel(this.HypermediaRels.thumbnailAlternative) || {}).href;
					}
				}

				this._rootUrl = (userResponse.getLinkByRel(this.HypermediaRels.root) || {}).href;
				if (this._rootUrl) {
					window.d2lauthify.fetchAsJson(this._generateRequest(this._rootUrl, "GET", this._headers)).then(this._onRootResponse.bind(this));
				}

				this._enrollmentsUrl = (userResponse.getLinkByRel(this.HypermediaRels.myEnrollments) || {}).href;
				if (this._enrollmentsUrl) {
					this._enrollmentsUrl += '?pageSize=2&orgUnitTypeId=3&embedDepth=1';
					window.d2lauthify.fetchAsJson(this._generateRequest(this._enrollmentsUrl, "GET", this._headers)).then(this._onEnrollmentsResponse.bind(this));
				}
			}
		},
		_onRootResponse: function(response) {
			if (response.status === 200) {
				var rootResponse = window.D2L.Hypermedia.Siren.Parse(response.detail);
				this._institutionUrl = (rootResponse.getLinkByRel(this.HypermediaRels.organization) || {}).href;

				if (this._institutionUrl) {
					window.d2lauthify.fetchAsJson(this._generateRequest(this._institutionUrl, "GET", this._headers)).then(this._onInstitutionResponse.bind(this));
				}
			}
		},
		_onEnrollmentsResponse: function(response) {
			if (response.status === 200) {
				var enrollmentsResponse = window.D2L.Hypermedia.Siren.Parse(response.detail);
				var enrollmentEntities = enrollmentsResponse.getSubEntitiesByRel(this.HypermediaRels.userEnrollment);

				if (enrollmentEntities.length === 1) {
					this._organizationsUrl = enrollmentEntities[0].getLinkByRel(this.HypermediaRels.organization).href;
					window.d2lauthify.fetchAsJson(this._generateRequest(this._organizationsUrl, "GET", this._headers)).then(this._onOrganizationsResponse.bind(this));
				}
			}
		},
		_onInstitutionResponse: function(response) {
			if (response.status === 200) {
				var institutionResponse = window.D2L.Hypermedia.Siren.Parse(response.detail);
				this._themeUrl = (institutionResponse.getLinkByRel('https://themes.api.brightspace.com/rels/theme') || {}).href;
				if (institutionResponse.properties) {
					this._school = institutionResponse.properties.name;
				}

				if (this._themeUrl) {
					window.d2lauthify.fetchAsJson(this._generateRequest(this._themeUrl, "GET", this._headers)).then(this._onThemeResponse.bind(this));
				}
			}
		},
		_onOrganizationsResponse: function(response) {
			if (response.status === 200) {
				var organizationsResponse = window.D2L.Hypermedia.Siren.Parse(response.detail);
				var imageLink = organizationsResponse.getSubEntityByClass( this.HypermediaClasses.courseImage.courseImage);

				if (imageLink) {
					this._organizationImageUrl = imageLink.href;
					window.d2lauthify.fetchAsJson(this._generateRequest(this._organizationImageUrl, "GET", this._headers)).then(this._onOrganizationImageResponse.bind(this));
				}
			}
		},
		_onOrganizationImageResponse: function(response) {
			if (response.status === 200) {
				var organizationImageResponse = window.D2L.Hypermedia.Siren.Parse(response.detail);
				var backgroundImages = this._getImageLinks(organizationImageResponse, this.HypermediaClasses.courseImage.wide);
				this._backgroundUrl = backgroundImages.highMin || backgroundImages.lowMax;
			}
		},

		_onThemeResponse: function(response) {
			if (response.status === 200) {
				var theme = window.D2L.Hypermedia.Siren.Parse(response.detail);

				if (theme.properties) {
					this._backgroundColor = theme.properties.BackgroundColor;
				}
			}
		}
	});
	</script>
</dom-module>
